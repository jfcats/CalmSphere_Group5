<div class="booking-layout">
  <div class="booking-card">
    
    <div class="header">
      <h2>Agendar Cita</h2>
      <p>Completa los datos para confirmar tu sesión.</p>
    </div>

    <form [formGroup]="form" (submit)="aceptar()">
      <input type="hidden" formControlName="idUsuario">

      <div class="section-block">
        <label class="block-label">1. Selección del Profesional</label>
        
        <div class="form-grid">
          <div class="full-width">
            <mat-form-field appearance="outline">
              <mat-label>Profesional</mat-label>
              <mat-select formControlName="idDoctorSeleccionado" (selectionChange)="alElegirDoctor($event.value)">
                <mat-option *ngFor="let doc of listaProfesionales" [value]="doc.id">
                  {{ doc.nombreCompleto }}
                </mat-option>
              </mat-select>
              <mat-icon matSuffix>account_circle</mat-icon>
            </mat-form-field>
          </div>

          <div class="full-width" *ngIf="serviciosDelDoctor.length > 0">
            <mat-form-field appearance="outline">
              <mat-label>Servicio</mat-label>
              <mat-select formControlName="idProfesionalServicio" (selectionChange)="alElegirServicio($event.value)">
                <mat-option *ngFor="let s of serviciosDelDoctor" [value]="s.idProfesionalServicio">
                  <div class="option-row space-between">
                    <span>{{ s.nombre }}</span>
                    <span class="price-badge">S/ {{ s.precioBase }}</span>
                  </div>
                </mat-option>
              </mat-select>
              <mat-icon matSuffix>medical_services</mat-icon>
            </mat-form-field>
          </div>
        </div>
      </div>

      <div class="section-block">
        <label class="block-label">2. Fecha y Hora</label>
        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Fecha</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="fecha" 
                   [matDatepickerFilter]="filtroFechas" (dateChange)="alCambiarFecha($event)">
            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>Hora Inicio</mat-label>
            <mat-select formControlName="horaInicio">
              <mat-option *ngFor="let slot of slotsDeTiempo" [value]="slot">
                {{ slot }}
              </mat-option>
              <mat-option *ngIf="slotsDeTiempo.length === 0" disabled>
                Elija una fecha primero
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>schedule</mat-icon>
          </mat-form-field>

          <div class="full-width">
             <mat-form-field appearance="outline">
                <mat-label>Motivo de la visita</mat-label>
                <textarea matInput formControlName="motivo" rows="3" placeholder="Ej: Me he sentido ansioso últimamente..."></textarea>
             </mat-form-field>
          </div>
        </div>
      </div>

      <div class="section-block">
         <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <mat-checkbox formControlName="pagarAhoraCheck" (change)="togglePago($event.checked)" color="primary">
               Quiero pagar ahora online
            </mat-checkbox>
            <h3 *ngIf="form.get('monto')?.value" style="color: #4f46e5; margin:0;">
               Total: S/ {{ form.get('monto')?.value }}
            </h3>
         </div>

         <div *ngIf="pagarAhora" style="background: #f9fafb; padding: 20px; border-radius: 10px;">
            <mat-form-field appearance="outline" style="width: 100%; margin-bottom: 15px;">
               <mat-label>Método de Pago</mat-label>
               <mat-select formControlName="idMetodoPago" (selectionChange)="verificarMetodoPago($event.value)">
                  <mat-option *ngFor="let mp of listaPagos" [value]="mp.idMetodoPago">
                     {{ mp.nombre }}
                  </mat-option>
               </mat-select>
            </mat-form-field>

            <div *ngIf="mostrarStripe">
               <ngx-stripe-card [options]="cardOptions" [elementsOptions]="elementsOptions"></ngx-stripe-card>
            </div>
         </div>
      </div>

      <div class="actions">
        <button type="button" class="btn-ghost" routerLink="/eventos">Cancelar</button>
        <button type="submit" class="btn-save" [disabled]="form.invalid || loading">
          {{ pagarAhora ? 'Pagar y Reservar' : 'Confirmar Cita' }}
        </button>
      </div>

    </form>
  </div>
</div>